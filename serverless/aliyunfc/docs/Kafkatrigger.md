Kafka 触发器

# 并发配置

#### 消费任务并发数

官方解释：通过设置消费并发数，您可以配置源 Kafka 实例的消费者数量。当您的 Kafka 实例有多个分区时，配置和分区数相同的消费并发数可以提高 Kafka 触发函数的并发情况。

官方解释：消费者的并发数量，取值范围为[1,Topic的分区数]。

官方解释：

> 您可以通过设置并发消费线程数提高吞吐，目前仅Kafka触发器支持设置并发配额，云消息队列 Kafka 版并发消费需配合Topic分区共同实现，包括以下几种场景。
>
> * Topic分区数=并发消费数：一个线程消费一个Topic分区。
>
> * Topic分区数>并发消费数：多个并发消费会均摊所有分区消费。
>
> * Topic分区数<并发消费数：一个线程消费一个Topic分区，多出的消费数无效。
>
> 说明：为保证您的资源被充分利用，建议您选择Topic分区数=并发消费数或Topic分区数>并发消费数场景。

我的理解：通过设置触发器内部并发消费线程数，可以让我们直观感受到消费速度提升（如果云函数处理事件速度够快的话）。因为设置的是触发器，所以在云函数这里我们观察不到任何资源数量的上升。

#### 投递并发最大值

官方解释：Kafka 投递到函数计算的并发最大值。

官方解释：Kafka 消息投递到函数计算的并发最大值，取值范围为 1~300。该参数仅对同步调用生效。如果需要更高的并发，请进入 EventBridge 配额中心申请配额名称为 EventStreaming FC Sink 同步投递最大并发数的配额。

我的理解：可以理解为函数实例的最大数量，如果有需要，函数计算会创建最多这么多个函数实例进行并发计算。

#### （批量）推送配置 

批量推送条数：一次调用函数发送的最大批量消息条数，当积压的消息数量到达设定值时才会发送请求，取值范围为 [1, 10000]。

批量推送间隔：调用函数的间隔时间，系统每到间隔时间点会将消息聚合后发给函数计算，取值范围为 [0,15]，单位秒。0 秒表示无等待时间，直接投递。

注意：

* 两个条件满足其中一个时，触发函数执行
* 需结合 body 大小限制决定是否减少聚合消息数
  * 同步调用：32 MB
  * 异步调用：128 KB
  
场景分析（TBD）

#### 函数实例并发度

官方解释：函数计算支持一个实例同时并发执行多个请求，这个值用来配置单个函数实例可以同时处理多少个请求。

我的理解：一次请求可以发送多个事件（根据批量推送配置而定）。

#### 并发能力计算

根据请求处理程序（Handler）对事件数组处理的不同，同一时刻云函数可以处理的事件数量上限不同：

* Handler 对数组中的事件顺序处理：<投递并发最大值> * <函数实例并发度>
* Handler 对数组中的事件并发处理：<投递并发最大值> * <函数实例并发度> * <批量推送条数>

# 重试和容错

TBD

# 参见

* [Kafka 触发器](https://help.aliyun.com/zh/fc/apsaramq-for-kafka-trigger)
* [触发器高级功能](https://help.aliyun.com/zh/fc/user-guide/advanced-features-of-triggers)
* [触发器 Event 格式](https://help.aliyun.com/zh/fc/user-guide/formats-of-event-for-different-triggers)
* [事件总线 EventBridge - 操作指南 - 事件流 - 事件源 - 消息队列 Kafka 版](https://help.aliyun.com/document_detail/439526.html)